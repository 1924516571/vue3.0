{"ast":null,"code":"/*\r\n * @Author: your name\r\n * @Date: 2021-01-13 17:32:55\r\n * @LastEditTime: 2021-12-02 17:02:24\r\n * @LastEditors: Please set LastEditors\r\n * @Description: In User Settings Edit\r\n * @FilePath: \\vue3-element-admin\\src\\plugins\\permission.js\r\n */\nimport { SET_MENU_LIST, SET_PERMISSION_LIST } from \"@/store/modules/app/type\";\nimport globalRoutes from \"@/router/globalRoutes\";\nimport mainRoutes from \"@/router/mainRoutes\";\nimport NProgress from \"nprogress\";\n/**\r\n * 判断当前路由类型, global: 全局路由, main: 主入口路由\r\n * @param {*} route 当前路由\r\n */\n\nfunction fnCurrentRouteType(route, globalRoutes = []) {\n  let temp = [];\n\n  for (let i = 0; i < globalRoutes.length; i++) {\n    if (route.name === globalRoutes[i].name) {\n      return \"global\";\n    } else if (globalRoutes[i].children && globalRoutes[i].children.length >= 1) {\n      temp = temp.concat(globalRoutes[i].children);\n    }\n  }\n\n  return temp.length >= 1 ? fnCurrentRouteType(route, temp) : \"main\";\n}\n\nexport default {\n  install: (app, {\n    router,\n    store\n  }) => {\n    // let router = opt;\n    router.beforeEach(async (to, from, next) => {\n      const token = store.getters.token;\n\n      if (router.options.isAddDynamicMenuRoutes || fnCurrentRouteType(to, globalRoutes) === \"global\") {\n        //* 1. 已经添加 or 全局路由, 直接访问\n        if (to.meta.title) {\n          document.title = to.meta.title;\n        }\n\n        NProgress.start();\n        next();\n      } else {\n        // let token = sessionStorage.getItem(\"token\");\n        if (!token || !/\\S/.test(token)) {\n          next({\n            name: \"Login\"\n          });\n        } else {\n          let data = await VE_API.system.userMenuList();\n\n          if (data && data.code === \"00\") {\n            let _list = XE.clone(data.list, true);\n\n            data.list = XE.mapTree(XE.toArrayTree(_list, {\n              sortKey: \"sort\"\n            }), item => {\n              if (item.children && item.children.length <= 0) {\n                delete item.children;\n              }\n\n              return item;\n            });\n            await fnAddDynamicMenuRoutes(data.list);\n            router.options.isAddDynamicMenuRoutes = true;\n            await store.dispatch(`app/${SET_MENU_LIST}`, data.list);\n            await store.dispatch(`app/${SET_PERMISSION_LIST}`, data.list);\n            NProgress.start();\n            next({ ...to,\n              replace: true\n            });\n          } else {\n            next({\n              name: \"Login\"\n            });\n          }\n        }\n      }\n    });\n    router.afterEach(() => {\n      NProgress.done();\n    });\n    /**\r\n     * 添加动态(菜单)路由\r\n     * @param {*} menuList 菜单列表\r\n     * @param {*} routes 递归创建的动态(菜单)路由\r\n     */\n    // eslint-disable-next-line no-unused-vars\n\n    const fnAddDynamicMenuRoutes = async (menuList = [], routes = []) => {\n      let temp = [];\n\n      for (let i = 0; i < menuList.length; i++) {\n        if (menuList[i].type == 0 && menuList[i].children && menuList[i].children.length >= 1) {\n          temp = temp.concat(menuList[i].children);\n        } else if (menuList[i].type == 1) {\n          // } else if (menuList[i].type==1 && /\\S/.test(menuList[i].url)) {\n          // const url = menuList[i].url.replace(/\\//g, \"_\");\n          let route = {\n            path: menuList[i].url.replace(/\\//g, \"-\") + `-${menuList[i].id}`,\n            component: null,\n            name: menuList[i].url.replace(/\\//g, \"-\") + `-${menuList[i].id}` // meta: {\n            // }\n\n          }; // url以http[s]://开头, 通过iframe展示\n\n          if (menuList[i].iframe == 1) {\n            route[\"path\"] = `i-${menuList[i].id}`;\n            route[\"name\"] = `i-${menuList[i].id}`;\n            route[\"props\"] = {\n              url: menuList[i].url\n            };\n\n            route[\"component\"] = () => import(\"@/views/IFrame.vue\");\n          } else {\n            const l = \"views/layoutpages/\" + menuList[i].url;\n\n            route[\"component\"] = () => import(\"@/\" + l + \".vue\");\n          }\n\n          routes.push(route);\n        }\n      }\n\n      if (temp.length >= 1) {\n        fnAddDynamicMenuRoutes(temp, routes);\n      } else {\n        mainRoutes.children = mainRoutes.children.concat(routes); // mainRoutes.children = routes;\n\n        console.log(\"控制台打印--> ~ file: permission.js ~ line 127 ~ fnAddDynamicMenuRoutes ~ mainRoutes.children\", mainRoutes.children);\n        await router.addRoute(mainRoutes);\n        await router.addRoute({\n          path: \"/:w+\",\n          redirect: {\n            name: \"404\"\n          }\n        });\n      }\n    };\n  }\n};","map":{"version":3,"names":["SET_MENU_LIST","SET_PERMISSION_LIST","globalRoutes","mainRoutes","NProgress","fnCurrentRouteType","route","temp","i","length","name","children","concat","install","app","router","store","beforeEach","to","from","next","token","getters","options","isAddDynamicMenuRoutes","meta","title","document","start","test","data","VE_API","system","userMenuList","code","_list","XE","clone","list","mapTree","toArrayTree","sortKey","item","fnAddDynamicMenuRoutes","dispatch","replace","afterEach","done","menuList","routes","type","path","url","id","component","iframe","l","push","console","log","addRoute","redirect"],"sources":["C:/Users/Administrator/Desktop/vue3-element-admin-dev/src/plugins/permission.js"],"sourcesContent":["/*\r\n * @Author: your name\r\n * @Date: 2021-01-13 17:32:55\r\n * @LastEditTime: 2021-12-02 17:02:24\r\n * @LastEditors: Please set LastEditors\r\n * @Description: In User Settings Edit\r\n * @FilePath: \\vue3-element-admin\\src\\plugins\\permission.js\r\n */\r\nimport { SET_MENU_LIST, SET_PERMISSION_LIST } from \"@/store/modules/app/type\";\r\n\r\nimport globalRoutes from \"@/router/globalRoutes\";\r\nimport mainRoutes from \"@/router/mainRoutes\";\r\nimport NProgress from \"nprogress\";\r\n\r\n/**\r\n * 判断当前路由类型, global: 全局路由, main: 主入口路由\r\n * @param {*} route 当前路由\r\n */\r\nfunction fnCurrentRouteType(route, globalRoutes = []) {\r\n    let temp = [];\r\n    for (let i = 0; i < globalRoutes.length; i++) {\r\n        if (route.name === globalRoutes[i].name) {\r\n            return \"global\";\r\n        } else if (\r\n            globalRoutes[i].children &&\r\n            globalRoutes[i].children.length >= 1\r\n        ) {\r\n            temp = temp.concat(globalRoutes[i].children);\r\n        }\r\n    }\r\n    return temp.length >= 1 ? fnCurrentRouteType(route, temp) : \"main\";\r\n}\r\n\r\nexport default {\r\n    install: (app, { router, store }) => {\r\n        // let router = opt;\r\n        router.beforeEach(async (to, from, next) => {\r\n            const token = store.getters.token;\r\n            if (\r\n                router.options.isAddDynamicMenuRoutes ||\r\n                fnCurrentRouteType(to, globalRoutes) === \"global\"\r\n            ) {\r\n                //* 1. 已经添加 or 全局路由, 直接访问\r\n                if (to.meta.title) {\r\n                    document.title = to.meta.title;\r\n                }\r\n                NProgress.start();\r\n                next();\r\n            } else {\r\n                // let token = sessionStorage.getItem(\"token\");\r\n                if (!token || !/\\S/.test(token)) {\r\n                    next({ name: \"Login\" });\r\n                } else {\r\n                    let data = await VE_API.system.userMenuList();\r\n                    if (data && data.code === \"00\") {\r\n                        let _list = XE.clone(data.list, true);\r\n                        data.list = XE.mapTree(\r\n                            XE.toArrayTree(_list, {\r\n                                sortKey: \"sort\",\r\n                            }),\r\n                            (item) => {\r\n                                if (\r\n                                    item.children &&\r\n                                    item.children.length <= 0\r\n                                ) {\r\n                                    delete item.children;\r\n                                }\r\n                                return item;\r\n                            }\r\n                        );\r\n                        await fnAddDynamicMenuRoutes(data.list);\r\n                        router.options.isAddDynamicMenuRoutes = true;\r\n                        await store.dispatch(`app/${SET_MENU_LIST}`, data.list);\r\n                        await store.dispatch(\r\n                            `app/${SET_PERMISSION_LIST}`,\r\n                            data.list\r\n                        );\r\n                        NProgress.start();\r\n                        next({ ...to, replace: true });\r\n                    } else {\r\n                        next({ name: \"Login\" });\r\n                    }\r\n                }\r\n            }\r\n        });\r\n        router.afterEach(() => {\r\n            NProgress.done();\r\n        });\r\n\r\n        /**\r\n         * 添加动态(菜单)路由\r\n         * @param {*} menuList 菜单列表\r\n         * @param {*} routes 递归创建的动态(菜单)路由\r\n         */\r\n        // eslint-disable-next-line no-unused-vars\r\n        const fnAddDynamicMenuRoutes = async (menuList = [], routes = []) => {\r\n            let temp = [];\r\n            for (let i = 0; i < menuList.length; i++) {\r\n                if (\r\n                    menuList[i].type == 0 &&\r\n                    menuList[i].children &&\r\n                    menuList[i].children.length >= 1\r\n                ) {\r\n                    temp = temp.concat(menuList[i].children);\r\n                } else if (menuList[i].type == 1) {\r\n                    // } else if (menuList[i].type==1 && /\\S/.test(menuList[i].url)) {\r\n                    // const url = menuList[i].url.replace(/\\//g, \"_\");\r\n                    let route = {\r\n                        path:\r\n                            menuList[i].url.replace(/\\//g, \"-\") +\r\n                            `-${menuList[i].id}`,\r\n                        component: null,\r\n                        name:\r\n                            menuList[i].url.replace(/\\//g, \"-\") +\r\n                            `-${menuList[i].id}`,\r\n                        // meta: {\r\n                        // }\r\n                    };\r\n                    // url以http[s]://开头, 通过iframe展示\r\n                    if (menuList[i].iframe == 1) {\r\n                        route[\"path\"] = `i-${menuList[i].id}`;\r\n                        route[\"name\"] = `i-${menuList[i].id}`;\r\n                        route[\"props\"] = { url: menuList[i].url };\r\n                        route[\"component\"] = () => import(\"@/views/IFrame.vue\");\r\n                    } else {\r\n                        const l = \"views/layoutpages/\" + menuList[i].url;\r\n                        route[\"component\"] = () => import(\"@/\" + l + \".vue\");\r\n                    }\r\n                    routes.push(route);\r\n                }\r\n            }\r\n            if (temp.length >= 1) {\r\n                fnAddDynamicMenuRoutes(temp, routes);\r\n            } else {\r\n                mainRoutes.children = mainRoutes.children.concat(routes);\r\n                // mainRoutes.children = routes;\r\n                console.log(\r\n                    \"控制台打印--> ~ file: permission.js ~ line 127 ~ fnAddDynamicMenuRoutes ~ mainRoutes.children\",\r\n                    mainRoutes.children\r\n                );\r\n\r\n                await router.addRoute(mainRoutes);\r\n                await router.addRoute({\r\n                    path: \"/:w+\",\r\n                    redirect: { name: \"404\" },\r\n                });\r\n            }\r\n        };\r\n    },\r\n};\r\n"],"mappings":"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"},"metadata":{},"sourceType":"module"}