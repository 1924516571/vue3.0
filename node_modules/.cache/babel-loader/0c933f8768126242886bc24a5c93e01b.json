{"ast":null,"code":"import { SET_MENU_LIST, SET_PERMISSION_LIST } from \"@/store/modules/app/type\";\nimport globalRoutes from \"@/router/globalRoutes\";\nimport mainRoutes from \"@/router/mainRoutes\";\nimport NProgress from \"nprogress\";\n/**\r\n * 判断当前路由类型, global: 全局路由, main: 主入口路由\r\n * @param {*} route 当前路由\r\n */\n\nfunction fnCurrentRouteType(route, globalRoutes = []) {\n  let temp = [];\n\n  for (let i = 0; i < globalRoutes.length; i++) {\n    if (route.name === globalRoutes[i].name) {\n      return \"global\";\n    } else if (globalRoutes[i].children && globalRoutes[i].children.length >= 1) {\n      temp = temp.concat(globalRoutes[i].children);\n    }\n  }\n\n  return temp.length >= 1 ? fnCurrentRouteType(route, temp) : \"main\";\n}\n\nexport default {\n  install: (app, {\n    router,\n    store\n  }) => {\n    // let router = opt;\n    router.beforeEach(async (to, from, next) => {\n      const token = store.getters.token;\n\n      if (router.options.isAddDynamicMenuRoutes || fnCurrentRouteType(to, globalRoutes) === \"global\") {\n        //* 1. 已经添加 or 全局路由, 直接访问\n        if (to.meta.title) {\n          document.title = to.meta.title;\n        }\n\n        NProgress.start();\n        next();\n      } else {\n        // let token = sessionStorage.getItem(\"token\");\n        if (!token || !/\\S/.test(token)) {\n          next({\n            name: \"Login\"\n          });\n        } else {\n          let data = await VE_API.system.userMenuList();\n\n          if (data && data.code === \"00\") {\n            let _list = XE.clone(data.list, true);\n\n            data.list = XE.mapTree(XE.toArrayTree(_list, {\n              sortKey: \"sort\"\n            }), item => {\n              if (item.children && item.children.length <= 0) {\n                delete item.children;\n              }\n\n              return item;\n            });\n            await fnAddDynamicMenuRoutes(data.list);\n            router.options.isAddDynamicMenuRoutes = true;\n            await store.dispatch(`app/${SET_MENU_LIST}`, data.list);\n            await store.dispatch(`app/${SET_PERMISSION_LIST}`, data.list);\n            NProgress.start();\n            next({ ...to,\n              replace: true\n            });\n          } else {\n            next({\n              name: \"Login\"\n            });\n          }\n        }\n      }\n    });\n    router.afterEach(() => {\n      NProgress.done();\n    });\n    /**\r\n     * 添加动态(菜单)路由\r\n     * @param {*} menuList 菜单列表\r\n     * @param {*} routes 递归创建的动态(菜单)路由\r\n     */\n    // eslint-disable-next-line no-unused-vars\n\n    const fnAddDynamicMenuRoutes = async (menuList = [], routes = []) => {\n      let temp = [];\n\n      for (let i = 0; i < menuList.length; i++) {\n        if (menuList[i].type == 0 && menuList[i].children && menuList[i].children.length >= 1) {\n          temp = temp.concat(menuList[i].children);\n        } else if (menuList[i].type == 1) {\n          // } else if (menuList[i].type==1 && /\\S/.test(menuList[i].url)) {\n          // const url = menuList[i].url.replace(/\\//g, \"_\");\n          let route = {\n            path: menuList[i].url.replace(/\\//g, \"-\") + `-${menuList[i].id}`,\n            component: null,\n            name: menuList[i].url.replace(/\\//g, \"-\") + `-${menuList[i].id}` // meta: {\n            // }\n\n          }; // url以http[s]://开头, 通过iframe展示\n\n          if (menuList[i].iframe == 1) {\n            route[\"path\"] = `i-${menuList[i].id}`;\n            route[\"name\"] = `i-${menuList[i].id}`;\n            route[\"props\"] = {\n              url: menuList[i].url\n            };\n\n            route[\"component\"] = () => import(\"@/views/IFrame.vue\");\n          } else {\n            const l = \"views/layoutpages/\" + menuList[i].url;\n\n            route[\"component\"] = () => import(\"@/\" + l + \".vue\");\n          }\n\n          routes.push(route);\n        }\n      }\n\n      if (temp.length >= 1) {\n        fnAddDynamicMenuRoutes(temp, routes);\n      } else {\n        mainRoutes.children = mainRoutes.children.concat(routes); // mainRoutes.children = routes;\n\n        console.log(\"控制台打印--> ~ file: permission.js ~ line 127 ~ fnAddDynamicMenuRoutes ~ mainRoutes.children\", mainRoutes.children);\n        await router.addRoute(mainRoutes);\n        await router.addRoute({\n          path: \"/:w+\",\n          redirect: {\n            name: \"404\"\n          }\n        });\n      }\n    };\n  }\n};","map":null,"metadata":{},"sourceType":"module"}